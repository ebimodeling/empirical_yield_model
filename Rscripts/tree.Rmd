---
title: "tree"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

Loading libraries:
```{r}
library(rpart)
library(grid)
library(partykit)
library(RWeka)
library(rattle)
library(RColorBrewer)
library(pander)
library(data.table)
library(knitr)

opts_chunk$set(echo = FALSE, message = FALSE, warnings = FALSE,  cache = FALSE)


```


## Data Prep

```{r}
download.file("https://gist.githubusercontent.com/dlebauer/357e02e5f91390fd9ca0/raw/e5f74e0d65b45014ecd9b29d90100b370b1a0f09/yields.csv", method = 'curl', destfile = 'yields.csv')
yields <- fread("yields.csv")
miscanthus <- yields[genus == "Miscanthus"]

#write.csv(miscanthus, file = "data/miscanthus.csv", row.names = FALSE)
```

```{r data-load}
#miscanthus <- fread("data/miscanthus.csv")

m <- miscanthus[!(is.na(planting_density) | is.na(yield)),
                `:=`(sacchariflorus = grepl('sacchariflorus', species),
                     sinensis = grepl('sinensis', species),
                     sinensis.Hybrid = grepl('Hybrid', species),
                     giganteus = grepl('giganteus', species))]

```

### Climate Data

#### WorldClim

```{r worldclim, eval=FALSE}
library(raster)

x <- getData('worldclim', var='tmin', res=0.5, lon=5, lat=45)

ans <- m[1, list(tmin = getData('worldclim', var = 'tmin', res = 0.5, lon = lon, lat = lat))]
```


#### RNCEP

```{r rncep}
library(RNCEP)

unique_xyt <- unique(m[,list(lat, lon, year) ])

get_met <- function(year, lat, lon, var){
  ans <- NCEP.gather(variable = var, level='gaussian', months.minmax=c(5,9), years.minmax = c(year,year), lat.southnorth = c(lat,lat), lon.westeast=c(lon,lon), reanalysis2 = TRUE, return.units = FALSE, status.bar=FALSE)

  ## geometric weighting 
  dlat <- abs(lat - as.numeric(dimnames(ans)[[1]]))
  dlon <- abs(lon - as.numeric(dimnames(ans)[[2]]))
  
  ans2 <- ans[1,,] * dlon[1]/sum(dlon) + ans[2,,]* dlon[2]/sum(dlon) 
  ans3 <- ans2[1,] * dlat[1]/sum(dlat) + ans2[1,]* dlat[2]/sum(dlat) 
  
  return(ans)
}


s2year <- udunits2::ud.convert(1, '1/s', '1/year')
## MAT = Mean Annual Temperature
unique_xyt[1, `:=` (MAT = mean(get_met(year, lat, lon, 'air.2m')),
                   MAP = sum(get_met(year, lat, lon, 'prate.sfc') * s2year),
                   PET = mean(get_met(year, lat, lon, 'pevpr.sfc')),
                   SOLAR = sum(get_met(year, lat, lon, 'dswrf.sfc')))]

save(unique_xyt, file = "~/met.RData")
```
## Analyses


### Regression Tree

```{r reg-tree}
rtree <- rpart(yield ~ sacchariflorus + sinensis + sinensis.Hybrid + giganteus +
                 lat + lon + fertilizer_n + stand_age + irrigated + planting_density, 
               data = m)

plot(as.party(rtree),tp_args=list(id=FALSE))

pander(rtree$cptable)

opt <- which.min(rtree$cptable[,"xerror"])
cp <- rtree$cptable[opt,"CP"]

rtree_prune <- prune(rtree,cp=cp)
plot(as.party(rtree_prune),tp_args=list(id=FALSE))

fit <- rpart(yield~., method="anova", data=dataigb2_rtree)

summary(rtree)
```

TODO what do you see? what does it mean?

## Using M5P algorithm

```{r M5P}

m2 <- m[,list(yield, sacchariflorus = as.numeric(sacchariflorus), 
              sinensis = as.integer(sinensis), 
              sinensis.Hybrid = as.integer(sinensis.Hybrid), 
              giganteus = as.integer(giganteus),
              irrigated = as.integer(irrigated),
              lat, lon, fertilizer_n,  planting_density)]
m5pTree <- M5P(yield ~ sacchariflorus + sinensis + sinensis.Hybrid + giganteus +
                 lat + lon + fertilizer_n + irrigated + planting_density, 
         data = m2)
summary(m5pTree)
plot(m5pTree)
```

TODO what do you see? what does it mean?