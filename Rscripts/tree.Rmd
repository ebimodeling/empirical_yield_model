---
title: "tree"
output: html_document
---

running

```r
purl("Rscripts/tree.Rmd")
system("nohup R --no-save < tree.R", wait = FALSE)
```
Loading libraries:
```{r}
library(plyr)#try_default
library(rpart)
library(grid)
library(partykit)
library(RWeka)
library(rattle)
library(RColorBrewer)
library(pander)
library(data.table)
library(knitr)
library(printr)
library(splitstackshape)

opts_chunk$set(echo = FALSE, message = FALSE, warnings = FALSE,  cache = FALSE)


```


## Data Prep

```{r}
download.file("https://gist.githubusercontent.com/dlebauer/357e02e5f91390fd9ca0/raw/e5f74e0d65b45014ecd9b29d90100b370b1a0f09/yields.csv", method = 'curl', destfile = 'yields.csv')
yields <- fread("yields.csv")

yields$age <- yields$year - yields$planting_date
miscanthus <- yields[genus == "Miscanthus"]

#write.csv(miscanthus, file = "data/miscanthus.csv", row.names = FALSE)
```

```{r data-load}
#miscanthus <- fread("data/miscanthus.csv")

m <- miscanthus[!(is.na(planting_density) | is.na(yield)),
                `:=`(sacchariflorus = grepl('sacchariflorus', species),
                     sinensis = grepl('sinensis', species),
                     sinensis.Hybrid = grepl('Hybrid', species),
                     giganteus = grepl('giganteus', species))]
m<-m[- grep('""""', m$planting_density),]
```

### Climate Data

#### WorldClim

```{r worldclim, eval=FALSE}
library(raster)

x <- getData('worldclim', var='tmin', res=0.5, lon=5, lat=45)

ans <- m[1, list(tmin = getData('worldclim', var = 'tmin', res = 0.5, lon = lon, lat = lat))]
```


#### RNCEP

```{r rncep}
library(maps)
library(RNCEP)
que_xyt <- unique(m[,list(lat, lon, year)])

get_met <- function(year, lat, lon, var){
  ans <- NULL
  ans <- try_default(quiet = TRUE, default = NA, expr = 
                       NCEP.gather(variable = var, level='gaussian', months.minmax=c(5,9), years.minmax = c(year,year), lat.southnorth = c(lat,lat), lon.westeast=c(lon,lon), reanalysis2 = TRUE, return.units = FALSE, status.bar=FALSE)
                     )
  
  if(any(!is.na(ans))){
    lats <- as.numeric(dimnames(ans)[[1]])
    lons <- as.numeric(dimnames(ans)[[2]])
    lons[lons>180] <- lons[lons>180] - 360
    dlat <- abs(lat - lats)
    dlon <- abs(lon - lons)
    #weights
    wlat <- dlat/sum(dlat, na.rm = TRUE)
    wlon <- dlon/sum(dlon, na.rm = TRUE)
    
    weights <- as.matrix(wlat) %*% t(as.matrix(wlon))
    
    
    ans2 <- rowMeans(ans, dims = 2, na.rm = TRUE)
    ans2.1 <- ans2[!is.nan(ans2)]
    
    ans3 <- sum(ans2.1 * weights)
    }
  return(ans3)
  }

## MAT = Mean Annual Temperature
ncep_data_list <- list()
for(i in 1:nrow(unique_xyt)){
  ncep_data_list[[i]] <- que_xyt[i, list(lat, lon, year, MAT = mean(get_met(year, lat, lon, 'air.2m')),
                                      MAP = sum(get_met(year, lat, lon, 'prate.sfc')),
                                      PET = mean(get_met(year, lat, lon, 'pevpr.sfc')),
                                      SOLAR = sum(get_met(year, lat, lon, 'dswrf.sfc'))
                                      )]
  
  
  ncep_data <- rbindlist(ncep_data_list)
  save(ncep_data, file = "~/ncep_data.RData") 
  }


ggplot() + geom_point(data = ncep_data, aes(lon, lat, color = MAP/PET))
```

```{r data_clean}

#density to numeric
m$planting_density <- as.numeric(m$planting_density)

#T/F to 1/0
m$giganteus <- as.numeric(m$giganteus)
m$sacchariflorus <- as.numeric(m$sacchariflorus)
m$sinensis <- as.numeric(m$sinensis)
m$sinensis.Hybrid <- as.numeric(m$sinensis.Hybrid)
m$irrigated <- as.numeric(m$irrigated)

#join two data frames by "lat, lon, year"
preJoinM <- transform(m , location = paste(lat, lon, year))
preJoinNcep <- transform(ncep_data , location = paste(lat, lon, year))

join <- merge(x = preJoinM, y = preJoinNcep, by = "location", all.x=TRUE)

#get the training data set 
trainingSet <- as.data.frame(subset(join, select = c("irrigated" , 
                "sacchariflorus" , "sinensis" , "sinensis.Hybrid" , "giganteus" ,
                "fertilizer_n","planting_density", "age" ,
                "MAT" , "MAP" , "PET" , "SOLAR",
                "yield")))

#make a new col P_PET
trainingSet$P_PET <- trainingSet$MAP/ trainingSet$PET

#scale the numeric data
scaledTrainingSet <- cbind(trainingSet[1:5] , scale(trainingSet[6:14]))

```

#### Daymet

_note:_ daymet only covers US, Canada, Mexico

```{r daymet, eval=FALSE}
if(require(DaymetR)){
  install_bitbucket("khufkens/daymetr", subdir = 'DaymetR')
} 
library(DaymetR)

dm <- list()
new_xyt <- unique_xyt[lon < -30]
for(i in 1:nrow(new_xyt)){
  rm(Daymet)
  try(
    new_xyt[i, download.daymet(lat = lat, lon = lon,internal = FALSE,  start_yr = year, end_yr = year)]
    )
  
  if(exists("Daymet")){
    d <- data.table(Daymet$data)

    dm[[i]] <- d[yday > 90 & yday < 270,
                 list(lat = Daymet$lattitude,
                      lon = Daymet$longitude,
                      elev = Daymet$altitude,
                      year = unique(year),
                      temp = mean(c(tmax..deg.c., 
                                    tmin..deg.c.)),
                      precip = sum(prcp..mm.day.),
                      vpd = mean(vp..Pa.))]
    } else {
      dm[[i]] <- NA
    }
  save(dm, file = "data/daymet.RData")
}

```
## Analyses


### Regression Tree

```{r reg-tree}

rtree <- rpart(yield ~ age  + PET +
                 MAT + SOLAR + P_PET +
                 sacchariflorus + sinensis + sinensis.Hybrid + giganteus +
                 fertilizer_n + irrigated + planting_density , 
               data = trainingSet,
               xval = 5,
               method="anova")

plot(as.party(rtree),tp_args=list(id=FALSE))
summary(rtree)
```

TODO what do you see? what does it mean?

### Random Forest

```{r randomForest}
rforest <- randomForest(yield ~ age  + PET +
                 MAT + SOLAR + P_PET +
                 sacchariflorus + sinensis + sinensis.Hybrid + giganteus +
                 fertilizer_n + irrigated + planting_density , 
               data = trainingSet,
               xval = 2,
               method="anova")

plot(as.party(rforest),tp_args=list(id=FALSE))
summary(rforest)
```


## Using M5P algorithm

```{r M5P}

m5pTree <- M5P(yield ~ age  + PET + MAT + SOLAR + 
                 sacchariflorus + sinensis + sinensis.Hybrid + giganteus +
                 fertilizer_n + irrigated + planting_density , 
               data = scaledTrainingSet)

summary(m5pTree)
plot(m5pTree)
```

TODO what do you see? what does it mean?